<tool id="recetox_aplcms_adjust_time" name="RECETOX apLCMS - adjust time" version="@TOOL_VERSION@+galaxy0">
    <description>extract features from LC/MS spectra</description>
    <macros>
        <import>macros.xml</import>
        <import>macros_split.xml</import>
    </macros>
    <expand macro="creator"/>

    <expand macro="requirements"/>
    <command detect_errors="aggressive"><![CDATA[
        sh ${symlink_inputs} &&
        Rscript -e 'source("${__tool_directory__}/utils.R")' -e 'source("${run_script}")'
    ]]></command>
    <configfiles>
        <configfile name="symlink_inputs">
            #for $infile in $files
                ln -s '${infile}' '${infile.element_identifier}'
            #end for
        </configfile>
        <configfile name="run_script"><![CDATA[
            #set filenames_str = str("', '").join([str($f.element_identifier) for $f in $files])
            files_list <- sort_samples_by_acquisition_number(c('$filenames_str'))

            extracted_features <- lapply(files_list, arrow::read_parquet)
            extracted_features <- lapply(extracted_features, as.matrix)

            corrected <- adjust.time(
                features = extracted_features,
                #if $peak_alignment.align_mz_tol:
                    mz.tol = $peak_alignment.align_mz_tol,
                #end if
                #if $peak_alignment.align_chr_tol:
                    chr.tol = $peak_alignment.align_chr_tol,
                #end if
                find.tol.max.d = 10 * $mz_tol,
                max.align.mz.diff = $peak_alignment.max_align_mz_diff,
                do.plot = FALSE
            )

            save_data_as_parquet_files(corrected, "corrected")
        ]]></configfile>
    </configfiles>

    <inputs>
        <param name="files" type="data" format="parquet" multiple="true" min="2" label="Input data"
               help="Mass spectrometry files containing feature samples." />
        <param name="mz_tol" type="float" value="1e-05" label="mz_tol"
               help="The m/z tolerance level for the grouping of data points. This value is expressed as the
               fraction of the m/z value. This value, multiplied by the m/z value, becomes the cutoff level.
               The recommended value is the machine's nominal accuracy level. Divide the ppm value by 1e6.
               For FTMS, 1e-5 is recommended." />
        <expand macro="peak_alignment"/>
    </inputs>

    <outputs>
        <collection name="corrected_feature_sample_tables" type="list"
                    label="${tool.name} corrected_feature_sample_tables on ${on_string}">
            <discover_datasets pattern="__designation__" directory="corrected" format="parquet" />
        </collection>
    </outputs>

    <tests>
        <test>
            <param name="files" ftype="parquet"
                   value="extracted_features_0.parquet,extracted_features_1.parquet,extracted_features_2.parquet"/>
            <output_collection name="corrected_feature_sample_tables" type="list">
                <element name="corrected_features_0.parquet" file="corrected_features_0.parquet" ftype="parquet"/>
                <element name="corrected_features_1.parquet" file="corrected_features_1.parquet" ftype="parquet"/>
                <element name="corrected_features_2.parquet" file="corrected_features_2.parquet" ftype="parquet"/>
            </output_collection>
        </test>
    </tests>

    <help>
        <![CDATA[
            This is a tool which runs apLCMS adjustment of time.

            @GENERAL_HELP@
        ]]>
    </help>

    <expand macro="citations"/>
</tool>
