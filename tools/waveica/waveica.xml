<tool id="waveica" name="WaveICA" version="@TOOL_VERSION@+galaxy3" python_template_version="3.5">
    <description>removal of batch effects for untargeted metabolomics data</description>
    <macros>
        <import>waveica_macros.xml</import>
    </macros>
    <expand macro="creator" />
    
    <requirements>
            <requirement type="package" version="@TOOL_VERSION@">r-recetox-waveica</requirement>
    </requirements>
    <command detect_errors="aggressive"><![CDATA[
        Rscript
            -e 'source("${__tool_directory__}/waveica_wrapper.R")'

            #if $batch_correction.mode == "batchwise":
            -e 'normalized_data <- waveica(
                data = "$data",
                wavelet_filter = "$wf.wavelet_filter",
                wavelet_length = "$wf.wavelet_length",
                k = $k,
                t = $batch_correction.t,
                t2 = $batch_correction.t2,
                alpha = $alpha,
                exclude_blanks = $exclude_blanks
            )'
            #else if $batch_correction.mode == "single_batch":
            -e 'normalized_data <- waveica_singlebatch(
                data = "$data",
                wavelet_filter = "$wf.wavelet_filter",
                wavelet_length = "$wf.wavelet_length",
                k = $k,
                alpha = $alpha,
                cutoff = $batch_correction.cutoff,
                exclude_blanks = $exclude_blanks
            )'
            #end if

            -e 'store_data(normalized_data,"$normalized_data")'
    ]]></command>

    <inputs>
        <expand macro="general_parameters" />
        <expand macro="wf" />
        <conditional name="batch_correction">
            <param name="mode" type="select" label="Batch correction mode" help="'multiple batches' takes into account inter- and intrabatch intensity drift; 'single batch' relies only on the injection order of the samples and requires no batch information [2]">
                <option value="batchwise" selected="true">Multiple batches</option>
                <option value="single_batch">Single batch (or no batch information)</option>
            </param>
            <when value="batchwise">
                <expand macro="batchwise_parameters" />
            </when> 
            <when value="single_batch">
                <expand macro="singlebatch_parameters" />
            </when>
        </conditional>
        <expand macro="exclude_blanks" />
    </inputs>

    <expand macro="outputs" />

    <tests>
        <test>
            <param name="data" value="input_data.csv" ftype="csv" />
            <param name="mode" value="batchwise" />
            <param name="wavelet_filter" value="d" />
            <param name="filter_length" value="2" />
            <param name="k" value="20" />
            <param name="t" value="0.05" />
            <param name="t2" value="0.05" />
            <param name="alpha" value="0" />
            <output name="normalized_data" file="normalized_data.tsv" /> 
        </test>
        <test>
            <param name="data" value="input_data_nobatch.csv" ftype="csv" />
            <param name="mode" value="single_batch" />
            <param name="wavelet_filter" value="d" />
            <param name="filter_length" value="2" />
            <param name="k" value="20" />
            <param name="alpha" value="0" />
            <param name="cutoff" value="0" />
            <output name="normalized_data" file="normalized_data_nobatch.tsv" /> 
        </test>
        <test expect_failure="true">
            <param name="data" value="na_data.csv" ftype="csv" />
        </test>
        <test expect_failure="true">
            <param name="data" value="incomplete_metadata_data.csv" ftype="csv" />
        </test>
    </tests>

    <help><![CDATA[
        **Description**

        Removal of batch effects for large-scale untargeted metabolomics data based on wavelet analysis. The WaveICA R package provides a new algorithm to removing batch effects for metabolomics data.
        
        The input is an intensity-by-feature table with metadata in the following format: 

        +---------------+--------+------------+----------------+-------+------------+--------------+-------------+-------------+-----+
        | sampleName    | class  | sampleType | injectionOrder | batch | M85T34     | M86T41       | M86T518     | M86T539     | ... |
        +===============+========+============+================+=======+============+==============+=============+=============+=====+
        | VT_160120_002 | sample | sample     | 1              | 1     | 228520.064 | 35646729.215 | 2386896.979 | 1026645.836 | ... |
        +---------------+--------+------------+----------------+-------+------------+--------------+-------------+-------------+-----+
        | QC1           | sample | QC         | 2              | 1     | 90217.384  | 35735702.457 | 2456290.696 | 1089246.460 | ... |
        +---------------+--------+------------+----------------+-------+------------+--------------+-------------+-------------+-----+
        | ...           | ...    | ...        | ...            | ...   | ...        | ...          | ...         | ...         | ... |
        +---------------+--------+------------+----------------+-------+------------+--------------+-------------+-------------+-----+


        + The required columns are **sampleName**, **class**, **sampleType**, **injectionOrder**, and the **features** that you want to normalize. 
        + The **batch** column is required if batch correction mode is **Multiple batches** and optional otherwise.
        + The presence of any additional columns (except features) will result in incorrect batch correction or job failure. 
        + the input table must not contain missing values. Missing intensities must be filled with 0.
        + **sampleType** column accepts three possible values: [QC, sample, blank] (case insensitive).
        + **class** column is used to denote a biological group of a sample (e.g., positive/negative species). The column accepts any values.
        + the **output** is the same table with corrected feature intensities.

        .. rubric:: **Footnotes**
        .. [1] for details on wavelet-filter parameters refer to R `wavelets::wt.filter <https://www.rdocumentation.org/packages/wavelets/versions/0.3-0.2/topics/wt.filter>`_;
        .. [2] when using 'Multiple batches', please cite the WaveICA (2019) paper; else, cite WaveICA 2.0 (2021) paper;

    
    ]]></help>

    <citations>
        <citation type="doi">10.1016/j.aca.2019.02.010</citation>
        <citation type="doi">10.1007/s11306-021-01839-7</citation>
    </citations>

</tool>