<tool id="waveica" name="WaveICA" version="@TOOL_VERSION@+galaxy1" python_template_version="3.5">
    <description>removal of batch effects for untargeted metabolomics data</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="creator"/>

    <requirements>
        <requirement type="package" version="@TOOL_VERSION@">r-recetox-waveica</requirement>
        <requirement type="package" version="8.0.0">r-arrow</requirement>
    </requirements>
    <command detect_errors="aggressive"><![CDATA[
        Rscript
            -e 'source("${__tool_directory__}/waveica_wrapper.R")'

            #if $batch_correction.mode == "batchwise":
            -e 'normalized_data <- waveica(
                #if $input_num.filetype.type_choice == "csv": 
                    file = "$input_num.filetype.input_csv.data",
                    #if $input_num.input_choice == "2":
                        metadata = "$input_num.filetype.input_csv_metadata.metadata",
                    #end if
                #else if $input_num.filetype.type_choice == "tsv":
                    file = "$input_num.filetype.input_tsv.data",
                    #if $input_num.input_choice == "2":
                        metadata = "$input_num.filetype.input_tsv_metadata.metadata",
                    #end if
                #else:
                    file = "$input_num.filetype.input_parquet.data",
                    #if $input_num.input_choice == "2":
                        metadata = "$input_num.filetype.input_parquet_metadata.metadata",
                    #end if
                #end if
                ext = "$input_num.filetype.type_choice",
                wavelet_filter = "$wf.wavelet_filter",
                wavelet_length = "$wf.wavelet_length",
                k = $k,
                t = $batch_correction.t,
                t2 = $batch_correction.t2,
                alpha = $alpha,
                exclude_blanks = $exclude_blanks
            )'
            #else if $batch_correction.mode == "single_batch":
            -e 'normalized_data <- waveica_singlebatch(
                #if $input_num.filetype.type_choice == "csv": 
                    file = "$input_num.filetype.input_csv.data",
                    #if $input_num.input_choice == "2":
                        metadata = "$input_num.filetype.input_csv_metadata.metadata",
                    #end if
                #else if $input_num.filetype.type_choice == "tsv": 
                    file = "$input_num.filetype.input_tsv.data",
                    #if $input_num.input_choice == "2":
                        metadata = "$input_num.filetype.input_tsv_metadata.metadata",
                    #end if
                #else:
                    file = "$input_num.filetype.input_parquet.data",
                    #if $input_num.input_choice == "2":
                        metadata = "$input_num.filetype.input_parquet_metadata.metadata",
                    #end if
                #end if
                ext = "$input_num.filetype.type_choice",
                wavelet_filter = "$wf.wavelet_filter",
                wavelet_length = "$wf.wavelet_length",
                k = $k,
                alpha = $alpha,
                cutoff = $batch_correction.cutoff,
                exclude_blanks = $exclude_blanks
            )'
            #end if

            -e 'store_data(normalized_data, "$normalized_data", "$input_num.filetype.type_choice")'
    ]]></command>

    <inputs>
        <conditional name="input_num">
            <param name="input_choice" type="select" label="Choose input files:">
                    <option value="1" selected="true">1</option>
                    <option value="2">2</option>
            </param>
            <when value="1">
                <conditional name="filetype">
                    <param name="type_choice" type="select" label="Choose input format:">
                        <option value="csv" selected="true">CSV</option>
                        <option value="tsv">TSV</option>
                        <option value="parquet">PARQUET</option>
                    </param>
                    <when value="csv">
                        <expand macro="parameters_csv" />
                    </when>
                    <when value="tsv">
                        <expand macro="parameters_tsv" />
                    </when>
                    <when value="parquet">
                        <expand macro="parameters_parquet" />
                    </when>
                </conditional>
            </when>
            <when value="2">
                <conditional name="filetype">
                    <param name="type_choice" type="select" label="Choose input format:">
                        <option value="csv" selected="true">CSV</option>
                        <option value="tsv">TSV</option>
                        <option value="parquet">PARQUET</option>
                    </param>
                    <when value="csv">
                        <expand macro="parameters_csv" />
                        <section name="input_csv_metadata" title="Input metadata table" expanded="true">
                            <param name="metadata" label="Input metadata" type="data" format="csv" help="" />
                        </section>        
                    </when>
                    <when value="tsv">
                        <expand macro="parameters_tsv" />
                        <section name="input_tsv_metadata" title="Input metadata table" expanded="true">
                            <param name="metadata" label="Input metadata" type="data" format="tsv" help="" />
                        </section> 
                    </when>
                    <when value="parquet">
                        <expand macro="parameters_parquet" />
                        <section name="input_parquet_metadata" title="Input metadata table" expanded="true">
                            <param name="metadata" label="Input metadata" type="data" format="parquet" help="" />
                        </section> 
                    </when>
                </conditional>
            </when>
        </conditional>
        <expand macro="general_parameters"/>
        <expand macro="wf"/>
        <conditional name="batch_correction">
            <param name="mode" type="select" label="Batch correction mode" help="'multiple batches' takes into account
            inter- and intrabatch intensity drift; 'single batch' relies only on the injection order of the samples and
            requires no batch information [2]">
                <option value="batchwise" selected="true">Multiple batches</option>
                <option value="single_batch">Single batch (or no batch information)</option>
            </param>
            <when value="batchwise">
                <expand macro="batchwise_parameters"/>
            </when>
            <when value="single_batch">
                <expand macro="singlebatch_parameters"/>
            </when>
        </conditional>
        <expand macro="exclude_blanks"/>
    </inputs>

    <expand macro="outputs"/>

    <tests>
        <test><!-- TEST 1 -->
            <param name="type_choice" value="csv"/>
            <param name="data" value="input_data.csv" ftype="csv"/>
            <param name="mode" value="batchwise"/>
            <param name="wavelet_filter" value="d"/>
            <param name="filter_length" value="2"/>
            <param name="k" value="20"/>
            <param name="t" value="0.05"/>
            <param name="t2" value="0.05"/>
            <param name="alpha" value="0"/>
            <output name="normalized_data" file="normalized_data.csv"/>
        </test>
        <test><!-- TEST 2 -->
            <param name="type_choice" value="tsv"/>
            <param name="data" value="input_data.tsv" ftype="tsv"/>
            <param name="mode" value="batchwise"/>
            <param name="wavelet_filter" value="d"/>
            <param name="filter_length" value="2"/>
            <param name="k" value="20"/>
            <param name="t" value="0.05"/>
            <param name="t2" value="0.05"/>
            <param name="alpha" value="0"/>
            <output name="normalized_data" file="normalized_data.tsv"/>
        </test>
        <test><!-- TEST 3 -->
            <param name="type_choice" value="parquet"/>
            <param name="data" value="input_data.parquet" ftype="parquet"/>
            <param name="mode" value="batchwise"/>
            <param name="wavelet_filter" value="d"/>
            <param name="filter_length" value="2"/>
            <param name="k" value="20"/>
            <param name="t" value="0.05"/>
            <param name="t2" value="0.05"/>
            <param name="alpha" value="0"/>
            <output name="normalized_data" file="normalized_data.parquet"/>
        </test>
        <test><!-- TEST 4 -->
            <param name="input_choice" value="2"/>
            <param name="type_choice" value="csv"/>
            <param name="data" value="feature_table.csv" ftype="csv"/>
            <param name="metadata" value="metadata.csv" ftype="csv"/>
            <param name="mode" value="batchwise"/>
            <param name="wavelet_filter" value="d"/>
            <param name="filter_length" value="2"/>
            <param name="k" value="20"/>
            <param name="t" value="0.05"/>
            <param name="t2" value="0.05"/>
            <param name="alpha" value="0"/>
            <output name="normalized_data" file="normalized_data.csv"/>
        </test>
        <test><!-- TEST 5 -->
            <param name="input_choice" value="2"/>
            <param name="type_choice" value="tsv"/>
            <param name="data" value="feature_table.tsv" ftype="tsv"/>
            <param name="metadata" value="metadata.tsv" ftype="tsv"/>
            <param name="mode" value="batchwise"/>
            <param name="wavelet_filter" value="d"/>
            <param name="filter_length" value="2"/>
            <param name="k" value="20"/>
            <param name="t" value="0.05"/>
            <param name="t2" value="0.05"/>
            <param name="alpha" value="0"/>
            <output name="normalized_data" file="normalized_data.tsv"/>
        </test>
        <test><!-- TEST 6 -->
            <param name="input_choice" value="2"/>
            <param name="type_choice" value="parquet"/>
            <param name="data" value="feature_table.parquet" ftype="parquet"/>
            <param name="metadata" value="metadata.parquet" ftype="parquet"/>
            <param name="mode" value="batchwise"/>
            <param name="wavelet_filter" value="d"/>
            <param name="filter_length" value="2"/>
            <param name="k" value="20"/>
            <param name="t" value="0.05"/>
            <param name="t2" value="0.05"/>
            <param name="alpha" value="0"/>
            <output name="normalized_data" file="normalized_data.parquet"/>
        </test>
        <!-- The following test has different results on three platform I've tried -->
        <!-- <test>
            <param name="data" value="input_data_nobatch.csv" ftype="csv"/>
            <param name="mode" value="single_batch"/>
            <param name="wavelet_filter" value="d"/>
            <param name="filter_length" value="2"/>
            <param name="k" value="20"/>
            <param name="alpha" value="0"/>
            <param name="cutoff" value="0"/>
            <output name="normalized_data" file="normalized_data_nobatch.tsv"/>
        </test> -->
        <test expect_failure="true">
            <param name="data" value="na_data.csv" ftype="csv"/>
        </test>
        <test expect_failure="true">
            <param name="data" value="incomplete_metadata_data.csv" ftype="csv"/>
        </test>
    </tests>

    <help>
        <![CDATA[
        @HELP@
        ]]>
    </help>

    <citations>
        <citation type="doi">10.1016/j.aca.2019.02.010</citation>
        <citation type="doi">10.1007/s11306-021-01839-7</citation>
    </citations>

</tool>
