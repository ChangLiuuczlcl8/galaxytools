<tool id="waveica_singlebatch" name="WaveICA (single batch)" version="0.2.0+galaxy0" python_template_version="3.5">
    <macros>
        <import>waveica_macros.xml</import>
    </macros>
    
    <description>removal of batch effects for untargeted metabolomics data without brach information</description>
    
    <expand macro="requirements" />

    <command detect_errors="aggressive"><![CDATA[
        Rscript
            -e 'source("${__tool_directory__}/waveica_wrapper.R")'

            -e 'normalized_data <- waveica_singlebatch(
                data = "$data",
                wavelet_filter = "$wf.wavelet_filter",
                wavelet_length = "$wf.wavelet_length",
                k = $k,
                alpha = $alpha,
                cutoff = $cutoff,
                exclude_blanks = $exclude_blanks
            )'

            -e 'store_data(normalized_data,"$normalized_data")'
    ]]></command>

    <inputs>
        <expand macro="data" />
        <expand macro="wf" />
        <expand macro="k" />
        <expand macro="alpha" />
        <param type="float" value="0.1" name="cutoff" label="Cutoff" help="threshold of the variation explained by the injection order for independent components, should be between 0 and 1"/>
        <expand macro="exclude_blanks" />
    </inputs>

    <expand macro="outputs" />

    <tests>
        <test>
            <param name="data" value="input_data.csv" ftype="csv" />
            <param name="wavelet_filter" value="d" />
            <param name="filter_length" value="2" />
            <param name="k" value="20" />
            <param name="alpha" value="0" />
            <param name="cutoff" value="0" />
            <output name="normalized_data" file="normalized_data_nobatch.tsv" /> 
        </test>
        <test expect_failure="true">
            <param name="data" value="na_data.csv" ftype="csv" />
        </test>
        <test expect_failure="true">
            <param name="data" value="incomplete_metadata_data.csv" ftype="csv" />
        </test>
    </tests>

    <help><![CDATA[
        .. rubric:: **Footnotes**
        .. [1] for details on wavelet filter parameters refer to R `wavelets::wt.filter <https://www.rdocumentation.org/packages/wavelets/versions/0.3-0.2/topics/wt.filter>`_;

    ]]></help>

    <citations>
        <citation type="doi">10.1016/j.aca.2019.02.010</citation>
    </citations>

</tool>